name: CMake CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: msvc
            config: Release
            generator: 'Visual Studio 17 2022'
            toolset: ''

          - name: clangcl
            config: Release
            generator: 'Visual Studio 17 2022'
            toolset: 'ClangCL'

          - name: mingw-gcc
            config: Release
            mingw: true

    steps:
      - uses: actions/checkout@v4

      - name: Setup MSYS2 (MinGW-w64)
        if: ${{ matrix.mingw }}
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-ninja

      - name: Configure (MSVC / clang-cl)
        if: ${{ !matrix.mingw }}
        shell: pwsh
        run: |
          if ("${{ matrix.toolset }}" -ne "") {
            cmake -S . -B build -G "${{ matrix.generator }}" -A x64 -T ${{ matrix.toolset }}
          } else {
            cmake -S . -B build -G "${{ matrix.generator }}" -A x64
          }

      - name: Build (MSVC / clang-cl)
        if: ${{ !matrix.mingw }}
        shell: pwsh
        run: cmake --build build --config ${{ matrix.config }}

      - name: Configure (MinGW GCC)
        if: ${{ matrix.mingw }}
        shell: msys2 {0}
        run: cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=${{ matrix.config }}

      - name: Build (MinGW GCC)
        if: ${{ matrix.mingw }}
        shell: msys2 {0}
        run: cmake --build build
